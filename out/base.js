// Generated by CoffeeScript 1.6.3
var Base, DynamicExposed, EventEmitter2, Logger, RemoteContext, addr, addrs, crypto, guid, ips, name, os, util, _, _i, _len, _ref, _ref1,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  __slice = [].slice;

EventEmitter2 = require('eventemitter2').EventEmitter2;

util = require('util');

_ = require('../vendor/lodash');

RemoteContext = require('./context');

Logger = (function(_super) {
  __extends(Logger, _super);

  function Logger() {
    _ref = Logger.__super__.constructor.apply(this, arguments);
    return _ref;
  }

  Logger.prototype.name = 'Logger';

  Logger.prototype.log = function() {
    var _ref1;
    if ((_ref1 = this.opts) != null ? _ref1.debug : void 0) {
      return console.log(this.toString() + ' ' + util.format.apply(null, arguments));
    }
  };

  Logger.prototype.warn = function() {
    return console.warn('WARNING: ' + this.toString() + ' ' + util.format.apply(null, arguments));
  };

  Logger.prototype.err = function(str) {
    return this.emit('error', new Error("" + this + " " + str));
  };

  Logger.prototype.toString = function() {
    return "" + this.name + ": " + this.id + ":";
  };

  return Logger;

})(EventEmitter2);

crypto = require("crypto");

guid = function() {
  return crypto.randomBytes(6).toString('hex');
};

os = require("os");

ips = [];

_ref1 = typeof os.networkInterfaces === "function" ? os.networkInterfaces() : void 0;
for (name in _ref1) {
  addrs = _ref1[name];
  for (_i = 0, _len = addrs.length; _i < _len; _i++) {
    addr = addrs[_i];
    if (addr.family === 'IPv4') {
      ips.push(addr.address);
    }
  }
}

DynamicExposed = (function() {
  function DynamicExposed(fn) {
    this.fn = fn;
  }

  return DynamicExposed;

})();

Base = (function(_super) {
  __extends(Base, _super);

  Base.prototype.name = 'Base';

  function Base(opts, parent) {
    var log;
    this.opts = opts != null ? opts : {};
    if (_.isString(this.opts)) {
      this.opts = {
        id: this.opts
      };
    }
    _.defaults(this.opts, this.defaults);
    this.guid = guid();
    this.id = this.opts.id || this.guid;
    _.bindAll(this);
    log = this.log;
    this.pubsub = parent ? parent.pubsub : new EventEmitter2;
    this.exposed = parent ? parent.exposed : this.defaultExposed();
  }

  Base.prototype.defaultExposed = function() {
    var pubsub;
    pubsub = this.pubsub;
    return {
      _pnode: {
        id: this.id,
        guid: this.guid,
        ips: ips.filter(function(ip) {
          return ip !== '127.0.0.1';
        }),
        subscribe: function(event) {
          return this.events[event] = 1;
        },
        unsubscribe: function(event) {
          return delete this.events[event];
        },
        publish: function() {
          var args, event;
          event = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
          return pubsub.emit.apply(pubsub, [event].concat(args));
        },
        ping: function(cb) {
          return cb(true);
        },
        events: this.exposeDynamic(function() {
          return Object.keys(pubsub._events);
        })
      }
    };
  };

  Base.prototype.exposeDynamic = function(fn) {
    return new DynamicExposed(fn);
  };

  Base.prototype.expose = function(obj) {
    return _.merge(this.exposed, obj);
  };

  Base.prototype.exposeWith = function(ctx) {
    var _this = this;
    if (!(ctx instanceof RemoteContext)) {
      return this.err("must bound remote to a context");
    }
    return _.merge({}, this.exposed, function(a, b) {
      if (b instanceof DynamicExposed) {
        return b.fn();
      }
      if (typeof b === "function") {
        return _.bind(b, ctx);
      }
      return a;
    });
  };

  Base.prototype.ips = function() {
    return ips;
  };

  return Base;

})(Logger);

Base.Logger = Logger;

module.exports = Base;

/*
//@ sourceMappingURL=base.map
*/
